import{a as w}from"../vendor-aes-js-CVO7b-af.js";import{g as N}from"./address-C-94Rlzo.js";import{a as d,h as g,e as J,c as F}from"./bytes-BFUO92dS.js";import{k as b}from"./keccak256-BpI13PIi.js";import{t as H,U as ie}from"./strings-BqJBhWqj.js";import{D as T}from"./properties-Bism-GXA.js";import{L as O}from"./logger-BIOSViGG.js";import{p as R}from"./pbkdf2-RF0eycJB.js";import{s as I}from"../vendor-scrypt-js-pU08l4Iy.js";import{H as W,d as M,m as ae,e as fe}from"./hdnode-De1GriMn.js";import{c as ue}from"./signing-key-DZY4IiDE.js";import{r as A}from"./random-UwHXQyRf.js";const $="json-wallets/5.8.0";function C(e){return typeof e=="string"&&e.substring(0,2)!=="0x"&&(e="0x"+e),d(e)}function K(e,r){for(e=String(e);e.length<r;)e="0"+e;return e}function U(e){return typeof e=="string"?H(e,ie.NFKC):d(e)}function a(e,r){let t=e;const n=r.toLowerCase().split("/");for(let o=0;o<n.length;o++){let f=null;for(const c in t)if(c.toLowerCase()===n[o]){f=t[c];break}if(f===null)return null;t=f}return t}function pe(e){const r=d(e);r[6]=r[6]&15|64,r[8]=r[8]&63|128;const t=g(r);return[t.substring(2,10),t.substring(10,14),t.substring(14,18),t.substring(18,22),t.substring(22,34)].join("-")}const le=new O($);class me extends T{isCrowdsaleAccount(r){return!!(r&&r._isCrowdsaleAccount)}}function z(e,r){const t=JSON.parse(e);r=U(r);const n=N(a(t,"ethaddr")),o=C(a(t,"encseed"));(!o||o.length%16!==0)&&le.throwArgumentError("invalid encseed","json",e);const f=d(R(r,r,2e3,32,"sha256")).slice(0,16),c=o.slice(0,16),m=o.slice(16),u=new w.ModeOfOperation.cbc(f,c),s=w.padding.pkcs7.strip(d(u.decrypt(m)));let i="";for(let h=0;h<s.length;h++)i+=String.fromCharCode(s[h]);const l=H(i),y=b(l);return new me({_isCrowdsaleAccount:!0,address:n,privateKey:y})}function V(e){let r=null;try{r=JSON.parse(e)}catch{return!1}return r.encseed&&r.ethaddr}function G(e){let r=null;try{r=JSON.parse(e)}catch{return!1}return!(!r.version||parseInt(r.version)!==r.version||parseInt(r.version)!==3)}var D;(function(e){e[e.legacy=0]="legacy",e[e.eip2930=1]="eip2930",e[e.eip1559=2]="eip1559"})(D||(D={}));function Y(e){const r=ue(e);return N(J(b(J(r,1)),12))}var de=function(e,r,t,n){function o(f){return f instanceof t?f:new t(function(c){c(f)})}return new(t||(t=Promise))(function(f,c){function m(i){try{s(n.next(i))}catch(l){c(l)}}function u(i){try{s(n.throw(i))}catch(l){c(l)}}function s(i){i.done?f(i.value):o(i.value).then(m,u)}s((n=n.apply(e,r||[])).next())})};const S=new O($);function B(e){return e!=null&&e.mnemonic&&e.mnemonic.phrase}class ye extends T{isKeystoreAccount(r){return!!(r&&r._isKeystoreAccount)}}function he(e,r,t){if(a(e,"crypto/cipher")==="aes-128-ctr"){const o=C(a(e,"crypto/cipherparams/iv")),f=new w.Counter(o),c=new w.ModeOfOperation.ctr(r,f);return d(c.decrypt(t))}return null}function Z(e,r){const t=C(a(e,"crypto/ciphertext"));if(g(b(F([r.slice(16,32),t]))).substring(2)!==a(e,"crypto/mac").toLowerCase())throw new Error("invalid password");const o=he(e,r.slice(0,16),t);o||S.throwError("unsupported cipher",O.errors.UNSUPPORTED_OPERATION,{operation:"decrypt"});const f=r.slice(32,64),c=Y(o);if(e.address){let u=e.address.toLowerCase();if(u.substring(0,2)!=="0x"&&(u="0x"+u),N(u)!==c)throw new Error("address mismatch")}const m={_isKeystoreAccount:!0,address:c,privateKey:g(o)};if(a(e,"x-ethers/version")==="0.1"){const u=C(a(e,"x-ethers/mnemonicCiphertext")),s=C(a(e,"x-ethers/mnemonicCounter")),i=new w.Counter(s),l=new w.ModeOfOperation.ctr(f,i),y=a(e,"x-ethers/path")||M,h=a(e,"x-ethers/locale")||"en",k=d(l.decrypt(u));try{const v=fe(k,h),p=W.fromMnemonic(v,null,h).derivePath(y);if(p.privateKey!=m.privateKey)throw new Error("mnemonic mismatch");m.mnemonic=p.mnemonic}catch(v){if(v.code!==O.errors.INVALID_ARGUMENT||v.argument!=="wordlist")throw v}}return new ye(m)}function q(e,r,t,n,o){return d(R(e,r,t,n,o))}function we(e,r,t,n,o){return Promise.resolve(q(e,r,t,n,o))}function Q(e,r,t,n,o){const f=U(r),c=a(e,"crypto/kdf");if(c&&typeof c=="string"){const m=function(u,s){return S.throwArgumentError("invalid key-derivation function parameters",u,s)};if(c.toLowerCase()==="scrypt"){const u=C(a(e,"crypto/kdfparams/salt")),s=parseInt(a(e,"crypto/kdfparams/n")),i=parseInt(a(e,"crypto/kdfparams/r")),l=parseInt(a(e,"crypto/kdfparams/p"));(!s||!i||!l)&&m("kdf",c),(s&s-1)!==0&&m("N",s);const y=parseInt(a(e,"crypto/kdfparams/dklen"));return y!==32&&m("dklen",y),n(f,u,s,i,l,64,o)}else if(c.toLowerCase()==="pbkdf2"){const u=C(a(e,"crypto/kdfparams/salt"));let s=null;const i=a(e,"crypto/kdfparams/prf");i==="hmac-sha256"?s="sha256":i==="hmac-sha512"?s="sha512":m("prf",i);const l=parseInt(a(e,"crypto/kdfparams/c")),y=parseInt(a(e,"crypto/kdfparams/dklen"));return y!==32&&m("dklen",y),t(f,u,l,y,s)}}return S.throwArgumentError("unsupported key-derivation function","kdf",c)}function ve(e,r){const t=JSON.parse(e),n=Q(t,r,q,I.syncScrypt);return Z(t,n)}function ge(e,r,t){return de(this,void 0,void 0,function*(){const n=JSON.parse(e),o=yield Q(n,r,we,I.scrypt,t);return Z(n,o)})}function Ue(e,r,t,n){try{if(N(e.address)!==Y(e.privateKey))throw new Error("address/privateKey mismatch");if(B(e)){const p=e.mnemonic;if(W.fromMnemonic(p.phrase,null,p.locale).derivePath(p.path||M).privateKey!=e.privateKey)throw new Error("mnemonic mismatch")}}catch(p){return Promise.reject(p)}typeof t=="function"&&!n&&(n=t,t={}),t||(t={});const o=d(e.privateKey),f=U(r);let c=null,m=null,u=null;if(B(e)){const p=e.mnemonic;c=d(ae(p.phrase,p.locale||"en")),m=p.path||M,u=p.locale||"en"}let s=t.client;s||(s="ethers.js");let i=null;t.salt?i=d(t.salt):i=A(32);let l=null;if(t.iv){if(l=d(t.iv),l.length!==16)throw new Error("invalid iv")}else l=A(16);let y=null;if(t.uuid){if(y=d(t.uuid),y.length!==16)throw new Error("invalid uuid")}else y=A(16);let h=1<<17,k=8,v=1;return t.scrypt&&(t.scrypt.N&&(h=t.scrypt.N),t.scrypt.r&&(k=t.scrypt.r),t.scrypt.p&&(v=t.scrypt.p)),I.scrypt(f,i,h,k,v,64,n).then(p=>{p=d(p);const _=p.slice(0,16),X=p.slice(16,32),j=p.slice(32,64),ee=new w.Counter(l),te=new w.ModeOfOperation.ctr(_,ee),L=d(te.encrypt(o)),re=b(F([X,L])),E={address:e.address.substring(2).toLowerCase(),id:pe(y),version:3,crypto:{cipher:"aes-128-ctr",cipherparams:{iv:g(l).substring(2)},ciphertext:g(L).substring(2),kdf:"scrypt",kdfparams:{salt:g(i).substring(2),n:h,dklen:32,p:v,r:k},mac:re.substring(2)}};if(c){const P=A(16),ne=new w.Counter(P),oe=new w.ModeOfOperation.ctr(j,ne),ce=d(oe.encrypt(c)),x=new Date,se=x.getUTCFullYear()+"-"+K(x.getUTCMonth()+1,2)+"-"+K(x.getUTCDate(),2)+"T"+K(x.getUTCHours(),2)+"-"+K(x.getUTCMinutes(),2)+"-"+K(x.getUTCSeconds(),2)+".0Z";E["x-ethers"]={client:s,gethFilename:"UTC--"+se+"--"+E.address,mnemonicCounter:g(P).substring(2),mnemonicCiphertext:g(ce).substring(2),path:m,locale:u,version:"0.1"}}return JSON.stringify(E)})}function _e(e,r,t){if(V(e)){t&&t(0);const n=z(e,r);return t&&t(1),Promise.resolve(n)}return G(e)?ge(e,r,t):Promise.reject(new Error("invalid JSON wallet"))}function Le(e,r){if(V(e))return z(e,r);if(G(e))return ve(e,r);throw new Error("invalid JSON wallet")}export{Le as a,_e as d,Ue as e};
