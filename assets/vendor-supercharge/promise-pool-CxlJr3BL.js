var c={},l={},d={},m={},E;function R(){if(E)return m;E=1,Object.defineProperty(m,"__esModule",{value:!0}),m.ValidationError=void 0;class o extends Error{constructor(s){super(s),Error.captureStackTrace&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor)}static createFrom(s){return new this(s)}}return m.ValidationError=o,m}var f={},k;function g(){if(k)return f;k=1,Object.defineProperty(f,"__esModule",{value:!0}),f.PromisePoolError=void 0;class o extends Error{constructor(s,t){super(),this.raw=s,this.item=t,this.name=this.constructor.name,this.message=this.messageFrom(s),Error.captureStackTrace&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor)}static createFrom(s,t){return new this(s,t)}messageFrom(s){return s instanceof Error||typeof s=="object"?s.message:typeof s=="string"||typeof s=="number"?s.toString():""}}return f.PromisePoolError=o,f}var p={},v;function H(){if(v)return p;v=1,Object.defineProperty(p,"__esModule",{value:!0}),p.StopThePromisePoolError=void 0;class o extends Error{}return p.StopThePromisePoolError=o,p}var w;function V(){if(w)return d;w=1,Object.defineProperty(d,"__esModule",{value:!0}),d.PromisePoolExecutor=void 0;const o=y(),i=R(),s=g(),t=H();class a{constructor(){this.meta={tasks:[],items:[],errors:[],results:[],stopped:!1,concurrency:10,shouldResultsCorrespond:!1,processedItems:[],taskTimeout:0},this.handler=r=>r,this.errorHandler=void 0,this.onTaskStartedHandlers=[],this.onTaskFinishedHandlers=[]}useConcurrency(r){if(!this.isValidConcurrency(r))throw i.ValidationError.createFrom(`"concurrency" must be a number, 1 or up. Received "${r}" (${typeof r})`);return this.meta.concurrency=r,this}isValidConcurrency(r){return typeof r=="number"&&r>=1}withTaskTimeout(r){return this.meta.taskTimeout=r,this}concurrency(){return this.meta.concurrency}useCorrespondingResults(r){return this.meta.shouldResultsCorrespond=r,this}shouldUseCorrespondingResults(){return this.meta.shouldResultsCorrespond}taskTimeout(){return this.meta.taskTimeout}for(r){return this.meta.items=r,this}items(){return this.meta.items}itemsCount(){const r=this.items();return Array.isArray(r)?r.length:NaN}tasks(){return this.meta.tasks}activeTaskCount(){return this.activeTasksCount()}activeTasksCount(){return this.tasks().length}processedItems(){return this.meta.processedItems}processedCount(){return this.processedItems().length}processedPercentage(){return this.processedCount()/this.itemsCount()*100}results(){return this.meta.results}errors(){return this.meta.errors}withHandler(r){return this.handler=r,this}hasErrorHandler(){return!!this.errorHandler}handleError(r){return this.errorHandler=r,this}onTaskStarted(r){return this.onTaskStartedHandlers=r,this}onTaskFinished(r){return this.onTaskFinishedHandlers=r,this}hasReachedConcurrencyLimit(){return this.activeTasksCount()>=this.concurrency()}stop(){throw this.markAsStopped(),new t.StopThePromisePoolError}markAsStopped(){return this.meta.stopped=!0,this}isStopped(){return this.meta.stopped}async start(){return await this.validateInputs().prepareResultsArray().process()}validateInputs(){if(typeof this.handler!="function")throw i.ValidationError.createFrom("The first parameter for the .process(fn) method must be a function");const r=this.taskTimeout();if(!(r==null||typeof r=="number"&&r>=0))throw i.ValidationError.createFrom(`"timeout" must be undefined or a number. A number must be 0 or up. Received "${String(r)}" (${typeof r})`);if(!this.areItemsValid())throw i.ValidationError.createFrom(`"items" must be an array, an iterable or an async iterable. Received "${typeof this.items()}"`);if(this.errorHandler&&typeof this.errorHandler!="function")throw i.ValidationError.createFrom(`The error handler must be a function. Received "${typeof this.errorHandler}"`);return this.onTaskStartedHandlers.forEach(e=>{if(e&&typeof e!="function")throw i.ValidationError.createFrom(`The onTaskStarted handler must be a function. Received "${typeof e}"`)}),this.onTaskFinishedHandlers.forEach(e=>{if(e&&typeof e!="function")throw i.ValidationError.createFrom(`The error handler must be a function. Received "${typeof e}"`)}),this}areItemsValid(){const r=this.items();return!!(Array.isArray(r)||typeof r[Symbol.iterator]=="function"||typeof r[Symbol.asyncIterator]=="function")}prepareResultsArray(){const r=this.items();return Array.isArray(r)?this.shouldUseCorrespondingResults()?(this.meta.results=Array(r.length).fill(o.PromisePool.notRun),this):this:this}async process(){let r=0;for await(const e of this.items()){if(this.isStopped())break;this.shouldUseCorrespondingResults()&&(this.results()[r]=o.PromisePool.notRun),this.startProcessing(e,r),r+=1,await this.waitForProcessingSlot()}return await this.drained()}async waitForProcessingSlot(){for(;this.hasReachedConcurrencyLimit();)await this.waitForActiveTaskToFinish()}async waitForActiveTaskToFinish(){await Promise.race(this.tasks())}startProcessing(r,e){const n=this.createTaskFor(r,e).then(h=>{this.save(h,e).removeActive(n)}).catch(async h=>{await this.handleErrorFor(h,r,e),this.removeActive(n)}).finally(()=>{this.processedItems().push(r),this.runOnTaskFinishedHandlers(r)});this.tasks().push(n),this.runOnTaskStartedHandlers(r)}async createTaskFor(r,e){if(this.taskTimeout()===void 0)return this.handler(r,e,this);const[n,h]=this.createTaskTimeout(r);return Promise.race([this.handler(r,e,this),n()]).finally(h)}createTaskTimeout(r){let e;return[async()=>new Promise((j,C)=>{e=setTimeout(()=>{C(new s.PromisePoolError(`Task in promise pool timed out after ${this.taskTimeout()}ms`,r))},this.taskTimeout())}),()=>clearTimeout(e)]}save(r,e){return this.shouldUseCorrespondingResults()?this.results()[e]=r:this.results().push(r),this}removeActive(r){return this.tasks().splice(this.tasks().indexOf(r),1),this}async handleErrorFor(r,e,n){if(this.shouldUseCorrespondingResults()&&(this.results()[n]=o.PromisePool.failed),!this.isStoppingThePoolError(r)){if(this.isValidationError(r))throw this.markAsStopped(),r;this.hasErrorHandler()?await this.runErrorHandlerFor(r,e):this.saveErrorFor(r,e)}}isStoppingThePoolError(r){return r instanceof t.StopThePromisePoolError}isValidationError(r){return r instanceof i.ValidationError}async runErrorHandlerFor(r,e){var n;try{await((n=this.errorHandler)==null?void 0:n.call(this,r,e,this))}catch(h){this.rethrowIfNotStoppingThePool(h)}}runOnTaskStartedHandlers(r){this.onTaskStartedHandlers.forEach(e=>{e(r,this)})}runOnTaskFinishedHandlers(r){this.onTaskFinishedHandlers.forEach(e=>{e(r,this)})}rethrowIfNotStoppingThePool(r){if(!this.isStoppingThePoolError(r))throw r}saveErrorFor(r,e){this.errors().push(s.PromisePoolError.createFrom(r,e))}async drained(){return await this.drainActiveTasks(),{errors:this.errors(),results:this.results()}}async drainActiveTasks(){await Promise.all(this.tasks())}}return d.PromisePoolExecutor=a,d}var S;function y(){if(S)return l;S=1,Object.defineProperty(l,"__esModule",{value:!0}),l.PromisePool=void 0;const o=V();class i{constructor(t){this.timeout=void 0,this.concurrency=10,this.items=t??[],this.errorHandler=void 0,this.onTaskStartedHandlers=[],this.onTaskFinishedHandlers=[],this.shouldResultsCorrespond=!1}withConcurrency(t){return this.concurrency=t,this}static withConcurrency(t){return new this().withConcurrency(t)}withTaskTimeout(t){return this.timeout=t,this}static withTaskTimeout(t){return new this().withTaskTimeout(t)}for(t){const a=new i(t).withConcurrency(this.concurrency);return typeof this.errorHandler=="function"&&a.handleError(this.errorHandler),typeof this.timeout=="number"?a.withTaskTimeout(this.timeout):a}static for(t){return new this().for(t)}handleError(t){return this.errorHandler=t,this}onTaskStarted(t){return this.onTaskStartedHandlers.push(t),this}onTaskFinished(t){return this.onTaskFinishedHandlers.push(t),this}useCorrespondingResults(){return this.shouldResultsCorrespond=!0,this}async process(t){return new o.PromisePoolExecutor().useConcurrency(this.concurrency).useCorrespondingResults(this.shouldResultsCorrespond).withTaskTimeout(this.timeout).withHandler(t).handleError(this.errorHandler).onTaskStarted(this.onTaskStartedHandlers).onTaskFinished(this.onTaskFinishedHandlers).for(this.items).start()}}return l.PromisePool=i,i.notRun=Symbol("notRun"),i.failed=Symbol("failed"),l}var T={},_;function A(){return _||(_=1,Object.defineProperty(T,"__esModule",{value:!0})),T}var P={},b;function O(){return b||(b=1,Object.defineProperty(P,"__esModule",{value:!0})),P}var F;function q(){return F||(F=1,function(o){var i=c&&c.__createBinding||(Object.create?function(a,u,r,e){e===void 0&&(e=r);var n=Object.getOwnPropertyDescriptor(u,r);(!n||("get"in n?!u.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return u[r]}}),Object.defineProperty(a,e,n)}:function(a,u,r,e){e===void 0&&(e=r),a[e]=u[r]}),s=c&&c.__exportStar||function(a,u){for(var r in a)r!=="default"&&!Object.prototype.hasOwnProperty.call(u,r)&&i(u,a,r)};Object.defineProperty(o,"__esModule",{value:!0});const t=y();o.default=t.PromisePool,s(A(),o),s(y(),o),s(g(),o),s(O(),o),s(H(),o),s(R(),o)}(c)),c}var I=q();export{I as d};
