var y=Object.defineProperty;var p=(s,e,t)=>e in s?y(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var f=(s,e,t)=>p(s,typeof e!="symbol"?e+"":e,t);import{a as q}from"../vendor-axios-Hz4xvOoZ.js";import{s as w}from"../vendor-stream-browserify-BiXhMpOM.js";import{r as k}from"../vendor-async-retry-DWdC6xTk.js";class b{constructor({url:e,retryConfig:t,query:i,queryName:n,opts:r}){f(this,"queryVars",{});f(this,"queryFields");f(this,"queryInfo");f(this,"_query");f(this,"url");f(this,"config");f(this,"resultTracker",{numPages:0,numResults:0,done:!1});if(!e)throw new Error("URL is required");if(this.url=new URL(e),this.config={first:!1,userProvided:!1,numPages:1/0,numResults:1e3,retryOpts:{retries:3,maxTimeout:2e3,minTimeout:500,...t}},i===!1)return this;if(!i)throw new Error(`Unable to find query with name ${n}`);if(this.queryInfo={...i},this.queryFields=i.query,n.includes("arweave")&&this.url.host==="node1.bundlr.network"&&(this.url=new URL("https://arweave.net/graphql")),!(r!=null&&r.skipVariableSetters))for(const u of Object.keys(i.vars)){if(this[u])throw new Error(`Field setter ${u} has a key conflict - disable with opts.skipVariableSetters OR change the field name and add to query.remapVars`);this[u]=d=>(this.queryVars[u]=d,this)}return this}buildQuery(){var h,l;if(this.config.userProvided)return this;const e=o=>JSON.stringify(o,(a,c)=>{if(c instanceof Array)return c[0];if(typeof c=="object")return c;if(c!==!1)return""}).replaceAll(":","").replaceAll('"',"").replaceAll(",",`
          `),t=e(this.queryFields),i=e({pageInfo:{[((h=this.queryInfo.paging)==null?void 0:h.hasNextPage)??"hasNextPage"]:void 0}}).slice(1,-1),n=this.queryInfo.enumValues,r={...this.queryInfo.vars,...this.queryVars};for(const[o,a]of Object.entries(this.queryInfo.remapVars??{}))if((r==null?void 0:r[o])!==void 0){if(typeof a=="function"){const c=a(o,r[o],r);if(!c)continue;const[m,g]=c;if(r[m]=g,m===o)continue}else r[a]=r[o];r[o]=void 0}const u=JSON.stringify(r,function(o,a){return a===void 0||a instanceof Array||typeof a=="object"||typeof a=="number"||n!=null&&n.includes(o)?a:`'${a}'`}).replaceAll('"',"").replaceAll("'",'"').slice(1,-1);if(!((l=this==null?void 0:this.queryInfo)!=null&&l.name))throw new Error("Query name is undefined!");const d=this.queryInfo.paging?`query {
      ${this.queryInfo.name}(
        ${u}
      ) {
        edges {
          cursor
          node ${t}
        }
        ${i}
      }
    }`:`query {
    ${this.queryInfo.name}(
      ${u}
    ) 
    ${t}
  }`;return this._query=d,this}async getPage(){var i;if(this.resultTracker.done)return;if(this.buildQuery(),!this._query)throw new Error("Unable to run undefined query");let e;try{e=await k(async n=>{const r=await q(this.url.toString(),{method:"post",headers:{"Content-Type":"application/json"},data:{query:this._query}});if(r.data.errors)throw r;return r},this.config.retryOpts)}catch(n){throw new Error(`Error running query
 ${this._query} - ${n.message?n.message+" -":""} (${JSON.stringify(((i=n==null?void 0:n.data)==null?void 0:i.errors.map(r=>r.message))??(n==null?void 0:n.errors)??n)}) `)}if(this.config.userProvided)return this.trimmer([e.data.data].flat(20));const t=e.data.data[this.queryInfo.name];if(this.queryInfo.paging){const n=t.pageInfo[this.queryInfo.paging.hasNextPage]?t.edges.at(-1)[this.queryInfo.paging.cursor]:void 0;return this.queryVars.after=n,this.trimmer(t.edges.map(r=>r.node))}return this.trimmer([t].flat(20))}trimmer(e){var n,r;const t=++this.resultTracker.numPages,i=this.resultTracker.numResults+=e.length;if(e.length===0)return this.resultTracker.done=!0,e;if(t>=((n=this==null?void 0:this.config)==null?void 0:n.numPages)&&(this.resultTracker.done=!0),i>=((r=this==null?void 0:this.config)==null?void 0:r.numResults)){this.resultTracker.done=!0;const u=this.config.numResults-(i-e.length);return e.slice(0,u)}return e}async first(){const e=await this.getPage();return(e==null?void 0:e.at(0))??void 0}maxPages(e){return this.config.numPages=e,this}limit(e){return this.config.numResults=e,this}async all(){const e=[];do{const t=await this.getPage();if(!t)break;e.push(...t)}while(this.queryVars.after);return e}async*generator(){do{const e=await this.getPage();if(!e)return;for(const t of e)yield t}while(this.queryVars.after)}stream(){return w.Readable.from(this.generator())}query(e){return this._query=e,this.config.userProvided=!0,this}fields(e,t=!1){const i=(n,r,u)=>{for(const d of Object.keys(u)){let h=r[d];Array.isArray(h)&&(h=h[0]);const l=u[d];if(h===void 0)throw new Error(`Illegal field ${n}${d}`);typeof l=="object"&&i(n+d+".",h,l)}};return t||i("",this.queryFields,e),this.queryFields=e,this}variables(e){return this.queryVars={...this.queryVars,...e},this}async toQuery(){return await this.buildQuery(),this._query}tReturn(){return"tReturn"}tQuery(){return"tQuery"}tVars(){return"tVars"}async then(e,t){return this.all().then(e,t)}async catch(e){return this.then().catch(e)}async finally(e){return this.then().finally(e)}}const I={id:"",timestamp:0,height:"",previous:""},V={ids:void 0,minHeight:void 0,maxHeight:void 0,pageSize:10,after:void 0,sort:"DESC"},P={name:"blocks",query:I,vars:V,enumValues:["sort"],remapVars:{pageSize:"first",sort:(s,e)=>[s,e==="ASC"?"HEIGHT_ASC":"HEIGHT_DESC"],minHeight:(s,e,t)=>{t.height={...t.height,min:e},t.minHeight=void 0},maxHeight:(s,e,t)=>{t.height={...t.height,max:e},t.maxHeight=void 0}},paging:{hasNextPage:"hasNextPage",cursor:"cursor"}},T={id:"",anchor:"",signature:"",recipient:"",owner:{address:"",key:""},fee:{winston:"",ar:""},quantity:{winston:"",ar:""},data:{size:"",type:""},tags:[{name:"",value:""}],block:{id:"",timestamp:0,height:0,previous:""},bundledIn:{id:""}},x={ids:void 0,from:void 0,to:void 0,tags:void 0,bundledIn:void 0,minHeight:void 0,maxHeight:void 0,pageSize:10,after:void 0,sort:"DESC"},S={name:"transactions",query:T,enumValues:["sort"],vars:x,remapVars:{pageSize:"first",from:"owners",to:"recipients",sort:(s,e)=>[s,e==="ASC"?"HEIGHT_ASC":"HEIGHT_DESC"],minHeight:(s,e,t)=>{t.block={...t.block,min:e},t.minHeight=void 0},maxHeight:(s,e,t)=>{t.block={...t.block,max:e},t.maxHeight=void 0}},paging:{hasNextPage:"hasNextPage",cursor:"cursor"}},H={id:"",receipt:{deadlineHeight:0,signature:"",timestamp:0,version:""},tags:[{name:"",value:""}],address:"",token:"",signature:"",timestamp:0},_={ids:void 0,after:void 0,token:void 0,from:void 0,pageSize:100,sort:"ASC",tags:void 0,fromTimestamp:void 0,toTimestamp:void 0},E={name:"transactions",query:H,enumValues:["order"],vars:_,remapVars:{pageSize:"first",sort:"order",from:"owners",fromTimestamp:(s,e,t)=>{t.timestamp={...t.timestamp,from:new Date(e).getTime()},t.fromTimestamp=void 0},toTimestamp:(s,e,t)=>{t.timestamp={...t.timestamp,to:new Date(e).getTime()},t.toTimestamp=void 0}},paging:{hasNextPage:"hasNextPage",cursor:"cursor"}},R={"irys:transactions":E,"arweave:transactions":S,"arweave:blocks":P};class N{constructor(e={url:new URL("https://node1.bundlr.network/graphql")}){f(this,"opts");if(!e.url)throw new Error("URL is required");e.url=new URL(e.url),this.opts=e}search(e,t){const i=(t==null?void 0:t.query)??R[e];return new b({...this.opts,query:i,queryName:e})}}export{N as Q};
